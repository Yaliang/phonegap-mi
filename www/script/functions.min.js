function setCurrLocationHash(e){currLocationHash=e}function initialElementEventSetting(){FastClick.attach(document.body);var e=$("#footer-bar-input-comment-content");e.on("blur",function(){$("#footer-bar-send-comment").css("position","fixed").css("bottom","0"),0==e.val().length&&($("#footer-bar-input-comment-content").attr("placeholder","comment..."),$("#footer-bar-reply-to-id-label").html(""))});var t=$("#footer-bar-input-message-content");t.on("blur",function(){$("#footer-bar-send-message").css("position","fixed").css("bottom","0")}),$("#footer-bar-form-message-chat").submit(function(e){e.preventDefault()}),$("#footer-bar-form-comment").submit(function(e){e.preventDefault()}),$("#body-input-edit-profile-photo").on("click",function(){$("#body-input-edit-profile-photo").on("change",function(){alerttime+=1,$("#body-input-edit-profile-photo").unbind("change"),"canvas_ready"in profilePreview&&0==profilePreview.canvas_ready||(profilePreview.crop_into_canvas_and_image({width:120,height:120}),profilePreviewWaiting=setInterval(function(){if("canvas_ready"in profilePreview&&profilePreview.canvas_ready){var e=document.getElementById("body-profile-photo-preview-canvas"),t=e.getContext("2d");t.drawImage(profilePreview.cropped_image,0,0),clearInterval(profilePreviewWaiting)}},500))})}),$("#body-form-confirm-password").submit(function(e){e.preventDefault()}),$("#body-form-set-new-password").submit(function(e){e.preventDefault()}),$("#body-input-set-new-password").focusout(function(){if($(this).val().length<6){var e="Password should be at least 6 characters. Please reenter password.";$("#body-set-new-password-error").html(e)}}),$("#body-form-create-event").submit(function(e){e.preventDefault()}),$("#body-form-login").submit(function(e){e.preventDefault()}),$("#body-form-signup").submit(function(e){e.preventDefault()}),$("#body-input-insert-description-photo").on("change",function(){insertDescriptionPreviewPhoto()}),$("#body-input-create-event-description").on("focus",function(){}),$("#body-input-create-event-description").on("blur",function(){$("#body-input-create-event-insert-photo").parent().removeAttr("style")}),document.getElementById("body-input-create-event-insert-photo").onchange=function(){"canvas_ready"in eventPhotoPreview&&0==eventPhotoPreview.canvas_ready||(eventPhotoPreview.parseEXIFdata(),eventPhotoPreviewWaiting=setInterval(function(){"image_ready"in eventPhotoPreview&&eventPhotoPreview.image_ready&&(eventPhotoPreview.image.style.width="100%",$("#body-input-create-event-description").append(eventPhotoPreview.image),$("#body-input-create-event-description").append("</br>"),$("#body-input-create-event-insert-photo").val(""),clearInterval(eventPhotoPreviewWaiting))},5))},$("#body-form-set-group-name").submit(function(e){e.preventDefault()}),$(window).hashchange(function(){var e=currLocationHash,t=window.location.hash;"#page-login"==t&&"#page-loading"!=e&&"#page-login"!=e&&"#page-signup"!=e&&($.mobile.changePage("#page-event"),currLocationHash="#page-event"),"#page-setting"!=t||"#page-loading"!=e&&"#page-login"!=e&&"#page-signup"!=e||($.mobile.changePage("#page-login"),currLocationHash="#page-login")}),$(document).on("pageshow","#page-chat-messages",function(){$("#footer-bar-send-message").css("position","fixed").css("bottom","0").show(),$("html body").animate({scrollTop:$(document).height().toString()+"px"},{duration:500,complete:function(){$(window).on("swiperight",function(){pullMyChat(),window.history.back(),setCurrLocationHash("#page-event"),$(window).unbind("swiperight")})}})}),$(document).on("pagebeforehide","#page-chat-messages",function(){$("#footer-bar-send-message").hide()}),$(document).on("pageshow","#page-event-detail",function(){$("#footer-bar-send-comment").css("position","fixed").css("bottom","0").show(),$(window).on("swiperight",function(){window.history.back(),setCurrLocationHash("#page-event"),$(window).unbind("swiperight")})}),$(document).on("pagebeforehide","#page-event-detail",function(){$("#footer-bar-send-comment").hide()}),$(document).on("pagebeforeshow","#page-change-my-password",function(){$("#body-form-confirm-password").show(),$("#body-form-set-new-password").hide(),$("#body-confirm-password-btn").show(),$("#body-set-new-password-btn").hide(),$("#body-input-old-password").val(""),$("#body-input-set-new-password").val(""),$("#body-input-confirm-new-password").val(""),$("#body-confirm-password-error").html(""),$("#body-set-new-password-error").html("")}),$(document).on("pageshow","#page-change-my-password",function(){$("#body-input-old-password").focus()}),$(document).on("pageshow","#page-event",function(){var e=$(window).height(),t=$("#page-event > .ui-header").outerHeight(),o=$("#page-event > .ui-footer").outerHeight();$("#page-event > .ui-content").css("height",(e-t-o).toString()+"px"),touch.touchInitialize("#page-event > .ui-content",function(){pullUserEvent({afterAt:currentFirstEvent}),console.log("pulltopfunction called")})}),$(document).on("pageshow","#page-friend",function(){var e=$(window).height(),t=$("#page-friend > .ui-header").outerHeight(),o=$("#page-friend > .ui-footer").outerHeight();$("#page-friend > .ui-content").css("height",(e-t-o).toString()+"px"),touch.touchInitialize("#page-friend > .ui-content")}),$(document).on("pageshow","#page-people-near-by",function(){var e=$(window).height(),t=$("#page-people-near-by > .ui-header").outerHeight();$("#page-people-near-by > .ui-content").css("height",(e-t).toString()+"px"),touch.touchInitialize("#page-people-near-by > .ui-content")}),$(document).on("pageshow","#page-people-search",function(){var e=$(window).height(),t=$("#page-people-search > .ui-header").outerHeight();$("#page-people-search > .ui-content").css("height",(e-t).toString()+"px"),touch.touchInitialize("#page-people-search > .ui-content")}),$(document).on("pageshow","#page-chat",function(){var e=$(window).height(),t=$("#page-chat > .ui-header").outerHeight(),o=$("#page-chat > .ui-footer").outerHeight();$("#page-chat > .ui-content").css("height",(e-t-o).toString()+"px"),touch.touchInitialize("#page-chat > .ui-content")}),$(document).on("pageshow","#page-setting",function(){var e=$(window).height(),t=$("#page-setting > .ui-header").outerHeight(),o=$("#page-setting > .ui-footer").outerHeight();$("#page-setting > .ui-content").css("height",(e-t-o).toString()+"px"),touch.touchInitialize("#page-setting > .ui-content")}),$(document).on("pageshow","#page-event-create",function(){eventPhotoPreview=loadedImage("#body-input-create-event-insert-photo")})}function loginByLocalStorage(){var e=Parse.User.current();if(e){var t=function(){registerNotificationId(),setCurrLocationHash("#page-event"),$.mobile.changePage("#page-event"),$.mobile.loading("show"),pullUserEvent(),pullNotificationRunning||setTimeout(function(){pullNotification()},5e3),ParsePullAllFriendObjectById(Parse.User.current().id),ParsePullMyChat(Parse.User.current().id,"updatedAt",function(){})},o=function(){setCurrLocationHash("#page-login"),$.mobile.changePage("#page-login")};ParseUpdateCurrentUser(t,o)}else{var n=$(window).width(),i=$(window).height(),a=$(".loading-page-image");n/i>1?(a.append("<div class='loading-page-button-top'>Join Us.</div>"),$(".loading-page-button-top").css("marginLeft",Math.round((a.width()-93-44)/2).toString()+"px")):(a.append("<div class='loading-page-button-bottom'>Join Us.</div>"),$(".loading-page-button-bottom").css("marginLeft",Math.round((a.width()-93-44)/2).toString()+"px"));var r=$("#page-loading");r.click(function(){setCurrLocationHash("#page-login"),$.mobile.changePage("#page-login")}),r.on("swiperight",function(){setCurrLocationHash("#page-login"),$.mobile.changePage("#page-login")}),r.on("swipeleft",function(){setCurrLocationHash("#page-login"),$.mobile.changePage("#page-login")})}}function pullNotification(){var e=Parse.User.current();if(null==e)return void(pullNotificationRunning=!1);pullNotificationRunning=!0;var t=function(e){"undefined"!=typeof e&&e.length>0?($(".footer-navigation-bar-friend").each(function(){$(this).addClass("friend-notification-custom")}),$("#body-new-friend-requests-btn").html("<span>New Friend Requests</span><span id='body-new-friend-requests-number' class='ui-li-friend-count'>"+e.length.toString()+"</span>").removeClass("ui-hidden-accessible"),$("#page-my-friend-requests > .ui-content").removeClass("ui-hidden-accessible")):($(".footer-navigation-bar-friend").each(function(){$(this).removeClass("friend-notification-custom")}),$("#body-new-friend-requests-btn").html("<span>New Friend Requests</span>"))};ParsePullUnreadFriendRequest(e.id,t),t=function(e){if("undefined"!=typeof e&&e.length>0?($(".footer-navigation-bar-chat").each(function(){$(this).addClass("chat-notification-custom")}),"page-chat"==$(":mobile-pagecontainer").pagecontainer("getActivePage")[0].id&&pullMyChat()):$(".footer-navigation-bar-chat").each(function(){$(this).removeClass("chat-notification-custom")}),"page-chat-messages"==$(":mobile-pagecontainer").pagecontainer("getActivePage")[0].id)for(var t=$("#footer-bar-group-id-label").html(),o=0;o<e.length;o++)t==e[o].get("groupId")&&updateChatMessage(e[o])},ParsePullUnreadChat(e.id,"updatedAt",t),"page-loading"==$(":mobile-pagecontainer").pagecontainer("getActivePage")[0].id&&loginByLocalStorage(),1==pullNotificationEnable?setTimeout(function(){pullNotification()},2e3):pullNotificationRunning=!1}function signup(){var e=$("#body-input-signup-name").val(),t=$("#body-input-signup-email").val(),o=$("#body-input-signup-password").val(),n=$("#body-signup-error"),i="#page-event",a=function(e){registerNotificationId(),$("#body-input-signup-password").val(""),pullUserEvent(),pullNotificationRunning||pullNotification(),ParseCreateProfilePhotoObject(e.id),sendVerifyEmail(e)};$.mobile.loading("show"),ParseSignup(t,o,t,e,n,i,a)}function sendVerifyEmail(e){var t="email="+e.get("email");t+="&username="+e.get("name"),t+="&verifyLink=http://yuemeuni.tk/verify.html?id="+e.id,$.post("https://yueme-push-server.herokuapp.com/varifyEmail",t).done(function(e){console.log(e)})}function login(){cacheInitialization();var e=$("#body-input-login-email").val(),t=$("#body-input-login-password").val(),o=$("#body-login-error"),n="#page-event",i=function(){registerNotificationId(),$("#body-input-login-password").val(""),pullUserEvent(),pullNotificationRunning||pullNotification(),ParsePullAllFriendObjectById(Parse.User.current().id),ParsePullMyChat(Parse.User.current().id,"updatedAt",function(){})};$.mobile.loading("show"),ParseLogin(e,t,o,n,i)}function logout(){var e=Parse.User.current(),t=e.getUsername();ParseRemoveCurrentBridgeitId(),$("#body-input-login-email").val(t),$("#body-login-error").html(""),$("#body-signup-error").html(""),localStorage.clear(),cacheClear(),$("#page-chat > .ui-content").html("");var o="#page-login";ParseLogout(o),unregisterNotificationId()}function convertTime(e){var t=6e4,o=60*t,n=24*o,i=30*n,a=365*n,r=new Date,s=r.getTime()-Date.parse(e.toString());s=Math.max(s,0);var c=Math.floor(s/a);s-=a*c;var u=Math.floor(s/i);s-=i*u;var g=Math.floor(s/n);s-=n*g;var p=Math.floor(s/o);s-=o*p;var d=Math.floor(s/t),l="";return l=c>0?c.toString()+(c>1?" years ago":" year ago"):u>0?u.toString()+(u>1?" months ago":" month ago"):g>0?g.toString()+(g>1?" days ago":" day ago"):p>0?p.toString()+(p>1?" hours ago":" hour ago"):d>0?d.toString()+(d>1?" mins ago":" min ago"):"just now"}function convertTimeFormat(e){var t=new Date(e),o=t.getFullYear(),n=t.getMonth(),i=t.getDate(),a=t.getHours(),r=t.getMinutes(),s=t.getDay(),c=new Date,u=c.getFullYear(),g=c.getMonth(),p=c.getDate(),d=new Date(u,g,p,0,0,0,0),l="",h=d.getTime()-t.getTime(),f=864e5;return l=0>=h?(10>a?"0"+a:a)+":"+(10>r?"0"+r:r):Math.floor(h/f)<=1?"Yesterday":Math.floor(h/f)<=3?DAYOFWEEK[s]:n+1+"/"+i+"/"+o%2e3}function convertTimeFormatToHourMinute(e){var t=e.getHours(),o=e.getMinutes(),n=e.getDay(),i=new Date,a=i.getFullYear(),r=i.getMonth(),s=i.getDate(),c=new Date(a,r,s,0,0,0,0),u="",g=c.getTime()-e.getTime(),p=864e5,d=(10>t?"0"+t:t)+":"+(10>o?"0"+o:o);return u=0>=g?d:Math.floor(g/p)<=1?"Yesterday "+d:Math.floor(g/p)<=3?DAYOFWEEK[n]+" "+d:e.toDateString()+" "+d}function sendToolbarActiveKeyboard(e){$("html body").animate({scrollTop:$(document).height().toString()+"px"},{duration:300,complete:function(){$(e.bar).css("position","absolute"),$(e.bar).css("bottom",($("body").height()-$(e.base).height()+e.bias).toString()+"px"),$(e.id).trigger("focus")}})}function pushNotificationToDevice(e,t,o){var n="id="+t+"&message="+o;$.post("https://yueme-push-server.herokuapp.com/"+e,n).done(function(e){})}function pushNotificationToDeviceByUsername(e,t){CacheGetProfileByUsername(e,function(e,t){var o;"undefined"!=typeof e.get("GCMId")&&(o=e.get("GCMId"),pushNotificationToDevice("gcm",o,t.message)),"undefined"!=typeof e.get("APNId")&&(o=e.get("APNId"),pushNotificationToDevice("apn",o,t.message))},{message:t})}function pushNotificationToDeviceByUserId(e,t){CacheGetProfileByUserId(e,function(e,t){var o;"undefined"!=typeof e.get("GCMId")&&(o=e.get("GCMId"),pushNotificationToDevice("gcm",o,t.message)),"undefined"!=typeof e.get("APNId")&&(o=e.get("APNId"),pushNotificationToDevice("apn",o,t.message))},{message:t})}var currLocationHash="#page-loading",alerttime=0,pullNotificationRunning=!1,DAYOFWEEK=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];