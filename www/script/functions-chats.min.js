function startPrivateChat(e){$("#page-chat-messages > .ui-content").html(""),$("#header-chat-message-title").html(""),$("#footer-bar-input-message-content").val("");var t=[];t.push(e),t.push(Parse.User.current().id);var a=function(e){var t=e.id,a=Parse.User.current().id;$("#footer-bar-group-id-label").html(t);var o=function(e){var t=e.get("groupId"),a=15,o="createdAt",r=function(e,t){for(var a=e.length-1;a>=0;a--){var o=new Date(e[a].createdAt);a==e.length-1?(previousTimeShown=o.getTime(),$("#page-chat-messages > .ui-content").append("<div class='chat-message-time'>"+convertTimeFormatToHourMinute(o)+"</div>")):(o.getTime()-previousTimeShown>=18e4&&$("#page-chat-messages > .ui-content").append("<div class='chat-message-time'>"+convertTimeFormatToHourMinute(o)+"</div>"),previousTimeShown=o.getTime());var r=buildElementInChatMessagesPage(e[a]);$("#page-chat-messages > .ui-content").append(r);var i=function(e,t){var a=e.get("profilePhoto120");"undefined"==typeof a&&(a="./content/png/Taylor-Swift.png"),$("#body-message-"+t.messageId).css("backgroundImage","url("+a+")")};CacheGetProfilePhotoByUserId(e[a].get("senderId"),i,{messageId:e[a].id})}$.mobile.changePage("#page-chat-messages")};ParsePullChatMessage(t,a,o,null,r,null)};ParseSetChatObjectAsRead(a,t,null,o)};CacheGetGroupIdInPrivateChat(t,a),updateChatTitle(e,"header-chat-message-title")}function startGroupChat(e){$("#page-chat-messages > .ui-content").html(""),$("#header-chat-message-title").html(""),$("#footer-bar-input-message-content").val("");var t=function(e){var t=e.get("memberId"),a=e.get("groupName");if("undefined"==typeof a)for(var o=0;o<t.length;o++)updateChatTitle(t[o],"header-chat-message-title");else $("#header-chat-message-title").html(a);var r=e.id,i=Parse.User.current().id;$("#footer-bar-group-id-label").html(r);var n=function(e){var t=e.get("groupId"),a=15,o="createdAt",r=function(e,t){for(var a=e.length-1;a>=0;a--){var o=new Date(e[a].createdAt);a==e.length-1?(previousTimeShown=o.getTime(),$("#page-chat-messages > .ui-content").append("<div class='chat-message-time'>"+convertTimeFormatToHourMinute(o)+"</div>")):(o.getTime()-previousTimeShown>=18e4&&$("#page-chat-messages > .ui-content").append("<div class='chat-message-time'>"+convertTimeFormatToHourMinute(o)+"</div>"),previousTimeShown=o.getTime());var r=buildElementInChatMessagesPage(e[a],!0);$("#page-chat-messages > .ui-content").append(r);var i=function(e,t){var a=e.get("profilePhoto120");"undefined"==typeof a&&(a="./content/png/Taylor-Swift.png"),$("#body-message-"+t.messageId).css("backgroundImage","url("+a+")")};CacheGetProfilePhotoByUserId(e[a].get("senderId"),i,{messageId:e[a].id})}$.mobile.changePage("#page-chat-messages")};ParsePullChatMessage(t,a,o,null,r,null)};ParseSetChatObjectAsRead(i,r,null,n)};CacheGetGroupMember(e,t)}function createGroupChat(){var e=function(e){var t=e.id,a=e.get("memberId");chatsInitializationNumber=a.length;for(var o=function(e){var t=e.get("groupId");chatsInitializationNumber--,0==chatsInitializationNumber&&startGroupChat(t)},r=0;r<a.length;r++)ParseInitializeChatObjectInGroup({groupId:t,ownerId:a[r],successFunction:o})};0==newGroupChatMemberArray.prevNum?1==newGroupChatMemberArray.newNum?startPrivateChat(newGroupChatMemberArray.newMemberList[0]):(newGroupChatMemberArray.newMemberList.push(Parse.User.current().id),newGroupChatMemberArray.newNum++,ParseCreateNewGroup(newGroupChatMemberArray.newMemberList,e)):newGroupChatMemberArray.isGroupChat?ParseAddGroupMember({groupId:newGroupChatMemberArray.groupId,newMemberList:newGroupChatMemberArray.newMemberList,successFunction:e}):ParseCreateNewGroup($.merge(newGroupChatMemberArray.memberId,newGroupChatMemberArray.newMemberList),e)}function buildElementInChatListPage(e){var t=e.id,a=(e.get("groupId"),e.get("unreadNum")),o="";if(o+="<div id='body-chat-"+t+"' class='chat-list'>",a>0){var r=a.toString().length,i=Math.max(9*r-1,11),n="-"+(i+8).toString()+"px",s=(i+9).toString()+"px";o+="<span class='ui-li-message-count' style='margin-right:"+n+"; right:"+s+"'>"+a+"</span>"}return o+="<div class='chat-list-title'></div>",o+="<div class='chat-last-time'></div>",o+="<div class='chat-last-message'></div>",o+="</div>"}function pullMyChat(){pullNotificationRunning||pullNotification();var e=Parse.User.current().id,t=function(e){for(var t=e.length-1;t>=0;t--)if(0==$("#body-chat-"+e[t].id).length){var a=buildElementInChatListPage(e[t]);$("#page-chat > .ui-content").prepend(a);var o=e[t].id,r={chatId:o},i=e[t].get("groupId"),n=function(e,t){var a=e.get("memberId"),o=e.id,r=e.get("groupName");if(e.get("isGroupChat")){if("undefined"==typeof r)for(i=0;i<a.length;i++)updateChatTitle(a[i],"body-chat-"+t.chatId+"> .chat-list-title");else $("#body-chat-"+t.chatId+"> .chat-list-title").html(r);$("#body-chat-"+t.chatId).css("backgroundImage","url(./content/png/Taylor_Swift_-_Red.png)").unbind("click").on("click",function(){$("#body-chat-"+t.chatId+"> .ui-li-message-count").remove(),startGroupChat(o)})}else for(var i=0;i<a.length;i++)if(a[i]!=Parse.User.current().id){updateChatTitle(a[i],"body-chat-"+t.chatId+"> .chat-list-title",2),t.friendId=a[i];var n=function(e,t){var a=e.get("profilePhoto120");"undefined"==typeof a&&(a="./content/png/Taylor-Swift.png"),$("#body-chat-"+t.chatId).css("backgroundImage","url("+a+")")};CacheGetProfilePhotoByUserId(t.friendId,n,t),$("#body-chat-"+t.chatId).unbind("click").on("click",function(){$("#body-chat-"+t.chatId+"> .ui-li-message-count").remove(),startPrivateChat(t.friendId)})}$("#body-chat-"+t.chatId).on("taphold",function(){$("#body-bottom-hiding-chat-confirm").unbind("click").on("click",function(){removeChat(t.chatId)}),$("#body-bottom-hiding-chat-cancel").unbind("click").on("click",function(){hideHidingChatMoreOption(t.chatId)}),displayHidingChatMoreOption(t.chatId)})};CacheGetGroupMember(i,n,r),updateLastMessage(i,r)}else{o=e[t].id,i=e[t].get("groupId"),r={chatId:o};var s=$("#body-chat-"+r.chatId);$("#page-chat > .ui-content").prepend(s),n=function(e,t){var a=e.get("memberId"),o=(e.id,e.get("groupName"));if(a.length>2&&"undefined"==typeof o)for($("#body-chat-"+t.chatId+"> .chat-list-title").html(""),j=0;j<a.length;j++)updateChatTitle(a[j],"body-chat-"+t.chatId+"> .chat-list-title")},CacheGetGroupMember(i,n,r);var d=$("#body-chat-"+r.chatId+"> .ui-li-message-count"),c=e[t].get("unreadNum");if(c>0){var h=c.toString().length,u=Math.max(9*h-1,11),g="-"+(u+8).toString()+"px",p=(u+9).toString()+"px",m="<span class='ui-li-message-count' style='margin-right:"+g+"; right:"+p+"'>"+c+"</span>";d.length>0?(d.before(m),d.remove()):s.prepend(m)}else d.length>0&&d.remove();updateLastMessage(i,r)}};CachePullMyChat(e,t)}function updateLastMessage(e,t){var a=!1,o=function(r){if(a=r.get("isGroupChat"),0==$("#body-chat-"+t.chatId+"> .ui-li-message-count").length&&"undefined"==typeof t.parse)o=function(t,o){if(null!=t)if($("#body-chat-"+o.chatId+"> .chat-last-time").html(convertTimeFormat(t.get("createdAt"))),a&&Parse.User.current().id!=t.get("senderId")){var r=function(e,t){var a="";a+=e.get("name")+": ",a+=t.message_object.get("text"),$("#body-chat-"+t.chatId+"> .chat-last-message").html(a)};o.message_object=t,CacheGetProfileByUserId(t.get("senderId"),r,o)}else{var i="";i+=t.get("text"),$("#body-chat-"+o.chatId+"> .chat-last-message").html(i)}else o.parse=!0,updateLastMessage(e,o)},CacheGetLatestMessage(e,o,t);else{var i=1,n="createdAt";o=function(e,t){if(e.length>0)if($("#body-chat-"+t.chatId+"> .chat-last-time").html(convertTimeFormat(e[0].createdAt)),a&&Parse.User.current().id!=e[0].get("senderId")){var o=function(e){var a="";a+=e.get("name")+": ",a+=t.message_object.get("text"),$("#body-chat-"+t.chatId+"> .chat-last-message").html(a)};t.message_object=e[0],CacheGetProfileByUserId(e[0].get("senderId"),o)}else{var i="";i+=e[0].get("text"),$("#body-chat-"+t.chatId+"> .chat-last-message").html(i)}else $("#body-chat-"+t.chatId+"> .chat-last-time").html(convertTimeFormat(r.createdAt))},ParsePullChatMessage(e,i,n,null,o,t)}};CacheGetGroupMember(e,o)}function buildElementInChatMessagesPage(e,t){var a,o=e.id,r=e.get("senderId"),i=Parse.User.current().id,n=e.get("text"),s="";if(a=i==r?"ui-custom-message-right":"ui-custom-message-left",s+="<div id='body-message-"+o+"' class='"+a+"'>",t&&i!=r){var d=function(e){var t=e.get("name");s+="<div class='body-message-username-in-group-chat'>"+t+"</div>"};CacheGetProfileByUserId(r,d)}return s+="<p>"+n+"</p>",s+="</div>"}function sendMessage(){var e=$("#footer-bar-group-id-label").html(),t=Parse.User.current().id,a=$("#footer-bar-input-message-content"),o=a.val();if(""!=o){a.val("");var r=function(e){var t=(e.id,e.get("senderId")),a=e.get("groupId"),o=e.get("text"),r=function(e,t,a){var o=function(e,t){"undefined"!=typeof e.get("GCMId")&&(t.GCMId=e.get("GCMId")),"undefined"!=typeof e.get("APNId")&&(t.APNId=e.get("APNId"));var a=function(e,t){var a=e.get("name")+": "+t.message;"GCMId"in t&&pushNotificationToDevice("gcm",t.GCMId,a),"APNId"in t&&pushNotificationToDevice("apn",t.APNId,a)};CacheGetProfileByUserId(t.senderId,a,t)},r={senderId:e,message:t};CacheGetProfileByUserId(a,o,r)};CacheSetGroupMemberChatObjectReadFalse(t,a,o,r);var i=!1,n=function(e,t){var a=new Date(t.message_object.createdAt);a.getTime()-previousTimeShown>=18e4&&$("#page-chat-messages > .ui-content").append("<div class='chat-message-time'>"+convertTimeFormatToHourMinute(a)+"</div>"),previousTimeShown=a.getTime(),i=e.get("isGroupChat");var o=buildElementInChatMessagesPage(t.message_object,i);$("#page-chat-messages > .ui-content").append(o);var r=function(e,t){var a=e.get("profilePhoto120");"undefined"==typeof a&&(a="./content/png/Taylor-Swift.png"),$("#body-message-"+t.messageId).css("backgroundImage","url('"+a+"')")};CacheGetProfilePhotoByUserId(t.message_object.get("senderId"),r,{messageId:t.message_object.id})};CacheGetGroupMember(e.get("groupId"),n,{message_object:e}),$("html body").animate({scrollTop:$(document).height().toString()+"px"},{duration:750,complete:function(){}});var s=$("#footer-bar-send-message");"absolute"==s.css("position")&&s.css("bottom",($("body").height()-$("#page-chat-messages").height()-43).toString()+"px")};ParseAddChatMessage(t,e,o,r)}}function updateChatTitle(e,t,a){if(e!=Parse.User.current().id){var o=function(e,o,r){if("undefined"!=typeof r){var i=r.get("alias"),n=$("#"+t);if("undefined"==typeof i){var s=function(e){var t="";a&&2==a?t=e.get("name"):(t=n.html(),t+=t.length>0?", "+e.get("name"):e.get("name")),n.html(t)};CacheGetProfileByUserId(o,s)}else{var d="";a&&2==a?d=i:(d=n.html(),d+=d.length>0?", "+i:i),n.html(d)}}else n=$("#"+t),s=function(e){var t="";a&&2==a?t=e.get("name"):(t=n.html(),t+=t.length>0?", "+e.get("name"):e.get("name")),n.html(t)},CacheGetProfileByUserId(o,s)};CacheCheckFriend(e,Parse.User.current().id,o)}}function updateChatMessage(e){var t=e.get("groupId"),a=e.updatedAt,o=e.get("unreadNum"),r="createdAt",i=function(e,t){for(var a=e.length-1;a>=0;a--)if(0==$("#body-message-"+e[a].id).length){var o=function(t,o){var r=Parse.User.current().id,i=t.get("isGroupChat"),n=buildElementInChatMessagesPage(e[a],i);$("#page-chat-messages > .ui-content").append(n);var s=function(e,t){var a=e.get("profilePhoto120");"undefined"==typeof a&&(a="./content/png/Taylor-Swift.png"),$("#body-message-"+t.messageId).css("backgroundImage","url("+a+")")};CacheGetProfilePhotoByUserId(e[a].get("senderId"),s,{messageId:e[a].id});var d=o.message_object.get("groupId");ParseSetChatObjectAsRead(r,d,1,function(){})};t.message_object=e[a],CacheGetGroupMember(e[a].get("groupId"),o,t)}$("html body").animate({scrollTop:$(document).height().toString()+"px"},{duration:750,complete:function(){}});var r=$("#footer-bar-send-message");"absolute"==r.css("position")&&r.css("bottom",($("body").height()-$("#page-chat-messages").height()-44).toString()+"px")};ParsePullChatMessage(t,o,r,a,i,{})}function displayChatMessageMoreOption(){$("#header-chat-message-more-option").removeClass("ui-header-more-option").addClass("ui-header-more-option-active");var e=$("#footer-bar-group-id-label").html(),t=function(e,t){e.get("memberId");if(e.get("isGroupChat")){var a=$("#body-bottom-group-chat-message-more-option");a.css("position","fixed").css("bottom",(-a.height()).toString()+"px").show().animate({bottom:"0px"},300)}else{var o=$("#body-bottom-private-chat-message-more-option");o.css("position","fixed").css("bottom",(-o.height()).toString()+"px").show().animate({bottom:"0px"},300)}$("body").append("<div class='ui-gray-cover' style='position:fixed; width:100%; height:100%; opacity:0; background-color:#000; z-index:1001' onclick='hideChatMessageMoreOption()'><div>"),$(".ui-gray-cover").animate({opacity:.3},300)};CacheGetGroupMember(e,t,{})}function hideChatMessageMoreOption(){$("#header-chat-message-more-option").addClass("ui-header-more-option").removeClass("ui-header-more-option-active");var e=$("#footer-bar-group-id-label").html(),t=function(e,t){e.get("memberId");if(e.get("isGroupChat")){var a=$("#body-bottom-group-chat-message-more-option");a.animate({bottom:(-a.height()).toString()+"px"},300,function(){$("#body-bottom-group-chat-message-more-option").hide()})}else{var o=$("#body-bottom-private-chat-message-more-option");o.animate({bottom:(-o.height()).toString()+"px"},300,function(){$("#body-bottom-private-chat-message-more-option").hide()})}$(".ui-gray-cover").animate({opacity:0},300,function(){$(".ui-gray-cover").remove()})};CacheGetGroupMember(e,t,{})}function displayHidingChatMoreOption(e){$("#body-chat-"+e).addClass("chat-message-selected").removeClass("chat-message-deselected");var t=$("#body-bottom-hiding-chat-more-option");t.css("position","fixed").css("bottom",(-t.height()).toString()+"px").show(),$("body").append("<div class='ui-gray-cover' style='position:fixed; width:100%; height:100%; opacity:0; background-color:#000; z-index:4'><div>"),$(".ui-gray-cover").on("click",function(){hideHidingChatMoreOption(e)}).animate({opacity:0},200),t.animate({bottom:"0px"},200)}function hideHidingChatMoreOption(e){var t=$("#body-bottom-hiding-chat-more-option");t.animate({bottom:(-t.height()).toString()+"px"},300,function(){t.hide()}),$(".ui-gray-cover").animate({opacity:0},300,function(){$(".ui-gray-cover").remove()}),$("#body-chat-"+e).addClass("chat-message-deselected").removeClass("chat-message-selected")}function selectANewParticipant(e){var t=e.data.id;newGroupChatMemberArray.newMemberList.push(t),newGroupChatMemberArray.newNum++,$("#header-add-participant-for-group-chat").html("OK("+newGroupChatMemberArray.newNum+")").unbind("click").click(createGroupChat),$("#body-add-participants-list-"+t).children(".ui-add-participant-unchecked").removeClass("ui-add-participant-unchecked").addClass("ui-add-participant-checked"),$("#body-add-participants-list-"+t).unbind("click").click({id:t},removeANewParticipant)}function removeANewParticipant(e){var t=e.data.id;newGroupChatMemberArray.newMemberList=jQuery.grep(newGroupChatMemberArray,function(e){return e!=t}),newGroupChatMemberArray.newNum--,newGroupChatMemberArray.newNum>0?$("#header-add-participant-for-group-chat").html("OK("+newGroupChatMemberArray.newNum+")").unbind("click").click(createGroupChat):$("#header-add-participant-for-group-chat").html("OK").unbind("click"),$("#body-add-participants-list-"+t).children(".ui-add-participant-checked").removeClass("ui-add-participant-checked").addClass("ui-add-participant-unchecked"),$("#body-add-participants-list-"+t).unbind("click").click({id:t},selectANewParticipant)}function pullGroupProfile(){var e=$("#footer-bar-group-id-label").html();$("#body-group-participants-list-toggle").html("Collapse List"),$("#body-group-participants-list").show(),pullParticipantsListInGroup();var t=function(e){var t=e.get("groupName");"undefined"==typeof t?(t="Not Set",$("#body-input-set-group-name").val("")):$("#body-input-set-group-name").val(t),$("#body-group-name").html("<font style='padding-right:1em; color:#333'>Group Name:</font><font style='color:#AAA'>"+t+"</font>")};CacheGetGroupMember(e,t)}function groupParticipantsListToggle(){var e=$("#body-group-participants-list-toggle"),t=e.html();0==t.localeCompare("Collapse List")?(e.html("Expand List"),$("#body-group-participants-list").slideUp()):(e.html("Collapse List"),$("#body-group-participants-list").slideDown())}function saveGroupName(){var e=$("#body-input-set-group-name").val();if(0==e.length)return void $.mobile.back();var t=$("#footer-bar-group-id-label").html(),a=function(e){var t=e.id,a=e.get("groupName");$("#body-input-set-group-name").val(a),$("#body-group-name").html("<font style='padding-right:1em'>Group Name:</font><font style='color:#AAA'>"+a+"</font>"),$("#header-chat-message-title").html(a);var o=function(e,t){$("#body-chat-"+e.id+" > .chat-list-title").html(t.groupName)};CacheGetChatByGroupId(Parse.User.current().id,t,o,{groupName:a})};ParseSetGroupName(t,e,a),$.mobile.back()}function removeChat(e){var t=function(e){$("#body-chat-"+e.id).remove(),hideHidingChatMoreOption(e.id)};ParseHideChat(e,null,null,t)}function leaveGroup(){var e=$("#footer-bar-group-id-label").html(),t=Parse.User.current().id,a=function(e){var t=e.id,a=e.get("ownerId"),o=e.get("groupId"),r=function(e,t){var a=t.chatId;$("#body-chat-"+a).remove()};ParseRemoveGroupMember({groupId:o,removeMemberList:[a],successFunction:r,data:{chatId:t}})};ParseDeleteChat(null,t,e,a)}function displayChatMoreOption(){var e=$("#header-start-group-chat-option");e.unbind("click"),$("#header-chat-more-option").removeClass("ui-header-more-option").addClass("ui-header-more-option-active"),$(window).unbind("scroll"),e.on("click",function(){pullFriendListForSelectingParticipantsInNewGroup(),hiddenChatMoreOption()});var t=$(".options-hidden-cover-layer");t.show(),$(".page-right-top-options").fadeIn("fast"),t.on("click",hiddenChatMoreOption).on("swipeleft",hiddenChatMoreOption).on("swiperight",hiddenChatMoreOption),$(window).scroll(hiddenChatMoreOption)}function hiddenChatMoreOption(){$("#header-start-group-chat-option").unbind("click"),$("#header-chat-more-option").removeClass("ui-header-more-option-active").addClass("ui-header-more-option"),$(window).unbind("scroll"),$(".options-hidden-cover-layer").hide(),$(".page-right-top-options").fadeOut("fast")}var previousTimeShown,chatsInitializationNumber=0;